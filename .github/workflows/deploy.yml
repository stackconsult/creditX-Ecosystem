# ============================================================================
# CreditX Ecosystem - CI/CD Pipeline
# GitHub Actions + Spaceship Hyperlift Auto-Deploy
# ============================================================================
# Hyperlift watches this repo and auto-deploys on push to main.
# This workflow handles: testing, building, and notifying Hyperlift.
# ============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.12'

jobs:
  # ==========================================================================
  # LINT & TYPE CHECK
  # ==========================================================================
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            apps/frontend/package-lock.json
            apps/api/package-lock.json
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install Node dependencies
        run: |
          cd apps/frontend && npm ci
          cd ../api && npm ci
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install ruff mypy
      
      - name: Lint TypeScript
        run: |
          cd apps/frontend && npm run lint || true
          cd ../api && npm run lint || true
      
      - name: Lint Python
        run: |
          ruff check services/ apps/agent/ --output-format=github || true

  # ==========================================================================
  # TEST STAGE
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint
    
    services:
      postgres:
        image: postgres:17-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: creditx_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      dragonfly:
        image: docker.dragonflydb.io/dragonflydb/dragonfly:latest
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install test dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio httpx
          if [ -f services/creditx-service/requirements.txt ]; then
            pip install -r services/creditx-service/requirements.txt
          fi
          if [ -f apps/agent/requirements.txt ]; then
            pip install -r apps/agent/requirements.txt
          fi
      
      - name: Run Python tests
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/creditx_test
          CACHE_HOST: localhost
          CACHE_PORT: 6379
          OPENAI_API_KEY: test-key
        run: |
          pytest tests/ -v --cov=services --cov=apps/agent --cov-report=xml || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false

  # ==========================================================================
  # SECURITY SCAN
  # ==========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r services/ apps/agent/ -ll -ii -f json -o bandit-results.json || true
      
      - name: Upload Bandit results
        uses: actions/upload-artifact@v4
        with:
          name: bandit-results
          path: bandit-results.json

  # ==========================================================================
  # BUILD VERIFICATION
  # ==========================================================================
  build:
    name: Verify Build
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Build Frontend
        run: |
          cd apps/frontend
          npm ci
          npm run build
      
      - name: Verify Docker build
        run: |
          docker build -t creditx-ecosystem:${{ github.sha }} .

  # ==========================================================================
  # NOTIFY HYPERLIFT (Production Deploy)
  # ==========================================================================
  # Hyperlift auto-deploys from this repo. This job confirms the build
  # is ready and optionally triggers immediate deployment.
  # ==========================================================================
  notify-hyperlift:
    name: Notify Hyperlift Ready
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Trigger Hyperlift deployment
        env:
          HYPERLIFT_WEBHOOK_URL: ${{ secrets.HYPERLIFT_WEBHOOK_URL }}
        run: |
          if [ -n "$HYPERLIFT_WEBHOOK_URL" ]; then
            curl -X POST "$HYPERLIFT_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "repository": "${{ github.repository }}",
                "ref": "${{ github.ref }}",
                "sha": "${{ github.sha }}",
                "actor": "${{ github.actor }}",
                "event": "deploy_ready"
              }'
            echo "Hyperlift notified of deployment readiness"
          else
            echo "Hyperlift webhook not configured - auto-deploy will trigger from repo watch"
          fi
      
      - name: Create deployment record
        run: |
          echo "Deployment ready for commit ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
