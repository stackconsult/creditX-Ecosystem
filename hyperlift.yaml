# ============================================================================
# Spaceship Hyperlift Configuration
# CreditX Ecosystem - Single App Deployment
# ============================================================================
# Hyperlift reads this file from the repo to configure deployments.
# Documentation: https://docs.spaceship.com/hyperlift
# ============================================================================
#
# ARCHITECTURE: Microservices in Single Container
# ─────────────────────────────────────────────────
# All services run within ONE Hyperlift container:
#   - nginx (PORT) → routes to internal services
#   - Next.js Frontend (:3000)
#   - Express API Gateway (:4000)
#   - Agent Orchestrator (:8010)
#   - CreditX Service (:8000)
#   - Threat Service (:8001)
#   - Guardian Service (:8002)
#
# This design provides:
#   ✓ Microservices architecture (internal service separation)
#   ✓ Single deployment unit (one Hyperlift app)
#   ✓ Internal localhost communication (fast, no network overhead)
#   ✓ Unified health endpoint for Hyperlift
#   ✓ Single domain with path-based routing
#
# ============================================================================

version: "1.0"
project: creditx-ecosystem

# ==========================================================================
# Build Configuration
# ==========================================================================
build:
  dockerfile: Dockerfile
  context: .
  args:
    NODE_VERSION: "20"
    PYTHON_VERSION: "3.12"

# ==========================================================================
# Application Configuration (Single App)
# ==========================================================================
app:
  name: creditx-ecosystem
  port: 3000  # Hyperlift will override via PORT env var
  
  healthcheck:
    path: /health
    interval: 30s
    timeout: 5s
    start_period: 60s
    retries: 3
  
  resources:
    cpu: 2.0
    memory: 4Gi
  
  autoscale:
    min: 2
    max: 10
    target_cpu: 70

# ==========================================================================
# Internal Services (for documentation - managed by supervisor)
# ==========================================================================
# These services run internally within the container.
# nginx routes external requests to appropriate internal service.
internal_services:
  frontend:
    internal_port: 3000
    path: /
    description: "Next.js Frontend (Consumer, Partner, Internal faces)"
  
  api_gateway:
    internal_port: 4000
    path: /api
    description: "Express.js API Gateway (BFF layer)"
  
  agent_orchestrator:
    internal_port: 8010
    path: /agent
    description: "FastAPI Agent Orchestrator (LangGraph/LangChain)"
  
  creditx_service:
    internal_port: 8000
    description: "CreditX Core Service (compliance, credit scoring)"
  
  threat_service:
    internal_port: 8001
    description: "Threat Detection Service"
  
  guardian_service:
    internal_port: 8002
    description: "Device Guardian Service"

# ==========================================================================
# Environments
# ==========================================================================
environments:
  production:
    branch: main
    auto_deploy: true
    url: https://creditx.credit
    env_vars:
      - NODE_ENV=production
      - ENVIRONMENT=production
    secrets:
      - OPENAI_API_KEY
      - COPILOTKIT_API_KEY
      - DATABASE_URL
      - CACHE_HOST
      - JWT_SECRET

  staging:
    branch: develop
    auto_deploy: true
    url: https://staging.creditx.credit
    env_vars:
      - NODE_ENV=staging
      - ENVIRONMENT=staging
    secrets:
      - OPENAI_API_KEY
      - DATABASE_URL
      - CACHE_HOST

# ==========================================================================
# Deployment Strategy
# ==========================================================================
deployment:
  strategy: blue-green
  rollback:
    enabled: true
    on_failure: true
    error_rate_threshold: 5
    latency_threshold_ms: 2000
  notifications:
    on_success: true
    on_failure: true

# ==========================================================================
# Database (Managed by Spaceship)
# ==========================================================================
database:
  type: postgres
  version: "17"
  size: standard
  backup:
    enabled: true
    schedule: "0 2 * * *"
    retention_days: 30

# ==========================================================================
# Cache (Managed by Spaceship)
# ==========================================================================
cache:
  type: dragonfly
  size: standard
  ha: true

# ==========================================================================
# Domain Configuration
# ==========================================================================
domain:
  primary: creditx.credit
  aliases:
    - www.creditx.credit
  tls:
    enabled: true
    auto_cert: true
  rate_limit:
    requests_per_minute: 1000
    burst: 100
